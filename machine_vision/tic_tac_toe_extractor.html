<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Tic Tac Toe Extractor</title>
  <style>
    canvas {
        width: 200px;
        height: 200px;
        border: solid 1px gray;
    }
    #in_canvas {
        margin-right: 1em;
    }
    .preview_canvas {
        width: 100px;
        height: 100px;
        border: solid 1px gray;
        image-rendering: pixelated;
    }
    .row {
        display: flex;
    }

    .stages {
        display: flex;
        border: solid 1px gray;
        margin-bottom: 0.5em;
    }
    .left {
        width: 10em;
        border-right: solid 1px gray;
        padding: 0 1em;
    }
    .right {
        padding: 1em;
    }
    .right > ul {
        margin-top: 0;
    }
    input[type=number] {
        width: 5em;
    }
  </style>
</head>

<body>
  <header>
    <h1>Tic Tac Toe Extractor</h1>
  </header>

  <main>
    <div class="row">
        <canvas id="in_canvas" width="160" height="120"></canvas>
        <div>
            <div>
                <canvas id="preview_canvas0" class="preview_canvas" width="8" height="8"></canvas>
                <canvas id="preview_canvas1" class="preview_canvas" width="8" height="8"></canvas>
                <canvas id="preview_canvas2" class="preview_canvas" width="8" height="8"></canvas>
            </div>
            <div>
                <canvas id="preview_canvas3" class="preview_canvas" width="8" height="8"></canvas>
                <canvas id="preview_canvas4" class="preview_canvas" width="8" height="8"></canvas>
                <canvas id="preview_canvas5" class="preview_canvas" width="8" height="8"></canvas>
            </div>
            <div>
                <canvas id="preview_canvas6" class="preview_canvas" width="8" height="8"></canvas>
                <canvas id="preview_canvas7" class="preview_canvas" width="8" height="8"></canvas>
                <canvas id="preview_canvas8" class="preview_canvas" width="8" height="8"></canvas>
            </div>
        </div>
    </div>

    <div class="stages">
        <div class="left">
            <h4>Stage 0:<br>Load File</h4>
        </div>
        <div class="right">
            <ul>
                <li>You must set the width, height, and format correctly before loading the image file.</li>
            </ul>
            Width:<input id="width" type="number" value="160" step="1">
            Height:<input id="height" type="number" value="120" step="1"><br>
            Display Scale:<input id="scale" type="number" value="2" step="1">
            <input id="file" type="file">
        </div>
    </div>
    <div class="stages">
        <div class="left">
            <h4>Stage 1:<br>Mark boxes</h4>
        </div>
        <div class="right">
            Start:<input id="start_x" type="number" value="76" step="1"><input id="start_y" type="number" value="19" step="1">
            Size:<input id="size" type="number" value="21" step="1">
            GapX:<input id="gap_x" type="number" value="1" step="1">
            GapY:<input id="gap_y" type="number" value="1" step="1">
        </div>
    </div>
    <div class="stages">
        <div class="left">
            <h4>Stage 2:<br>Extract</h4>
        </div>
        <div class="right">
            <ul>
                <li>Set threshold to 0 for auto threshold.</li>
                <li>Set threshold to -1 for a grayscale image.</li>
            </ul>
            Threshold:<input id="threshold" type="number" value="128" step="1">
            Output Size:<input id="outSize" type="number" value="8" step="1">
            <br>
            Filename Prefix:<input id="filenamePrefix" type="text" value="boxA">
            <button id="extract">Extract boxes</button>
        </div>
    </div>
  </main>

  <script>
    let width = 0;
    let height = 0;
    let buf = null;

    let canvas = document.getElementById('in_canvas');
    let widthInput = document.getElementById('width');
    let heightInput = document.getElementById('height');
    let fileInput = document.getElementById('file');
    let scaleInput = document.getElementById('scale');
    let startXInput = document.getElementById('start_x');
    let startYInput = document.getElementById('start_y');
    let sizeInput = document.getElementById('size');
    let gapXInput = document.getElementById('gap_x');
    let gapYInput = document.getElementById('gap_y');
    let thresholdInput = document.getElementById('threshold');
    let outSizeInput = document.getElementById('outSize');
    let filenamePrefixInput = document.getElementById('filenamePrefix');
    let extractButton = document.getElementById('extract');

    function drawToCanvas() {
        let ctx = canvas.getContext('2d');
        canvas.width = width;
        canvas.height = height;
        let scale = parseInt(scaleInput.value);
        canvas.style.width = (width * scale) + 'px';
        canvas.style.height = (height * scale) + 'px';

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;

        for (let y=0; y<height; y++) {
            for (let x=0; x<width; x++) {
                let pos = y * width + x;
                let canvas_pos = pos * 4;

                data[canvas_pos] = buf[pos];
                data[canvas_pos + 1] = buf[pos];
                data[canvas_pos + 2] = buf[pos];
                data[canvas_pos + 3] = 255;
            }
        }
        ctx.putImageData(imageData, 0, 0);
    }

    function drawBoxes() {
        let startX = parseInt(startXInput.value);
        let startY = parseInt(startYInput.value);
        let size = parseInt(sizeInput.value);
        let gapX = parseInt(gapXInput.value);
        let gapY = parseInt(gapYInput.value);

        let ctx = canvas.getContext('2d');
        ctx.strokeStyle = 'red';
        ctx.lineWidth = 1;

        for (let y=0; y<3; y+=1) {
            let y_pos = startY + y * (size + gapY);
            for (let x=0; x<3; x+=1) {
                let x_pos = startX + x * (size + gapX);
                ctx.strokeRect(x_pos, y_pos, size, size);
            }
        }
    }

    function draw() {
        if (buf == null) {
            return;
        }
        drawToCanvas();
        drawBoxes();
        extract(false);
    }

    function saveFile(buffer, filename) {
        const blob = new Blob([buffer], {type: 'application/octet-stream'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    }

    function drawPreview(index, view) {
        let outSize = parseInt(outSizeInput.value);
        let canvas = document.getElementById('preview_canvas' + index);
        let ctx = canvas.getContext('2d');
        // ctx.imageSmoothingEnabled = false;
        canvas.width = outSize;
        canvas.height = outSize;

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;

        for (let y=0; y<outSize; y++) {
            for (let x=0; x<outSize; x++) {
                let pos = y * outSize + x;
                let canvas_pos = pos * 4;

                data[canvas_pos] = view.getUint8(pos);
                data[canvas_pos + 1] = view.getUint8(pos);
                data[canvas_pos + 2] = view.getUint8(pos);
                data[canvas_pos + 3] = 255;
            }
        }
        ctx.putImageData(imageData, 0, 0);
    }

    function extract(save=true) {
        let startX = parseInt(startXInput.value);
        let startY = parseInt(startYInput.value);
        let size = parseInt(sizeInput.value);
        let gapX = parseInt(gapXInput.value);
        let gapY = parseInt(gapYInput.value);
        let threshold = parseInt(thresholdInput.value);
        let outSize = parseInt(outSizeInput.value);
        let filenamePrefix = filenamePrefixInput.value;

        let startOffset = size / outSize / 2;
        let stepSize = size / (outSize - 1);

        if (threshold == 0) {
            // auto threshold
            let minV = 255;
            let maxV = 0;
            for (let i=0; i<buf.length; i++) {
                let v = buf[i];
                if (v < minV) {
                    minV = v;
                }
                if (v > maxV) {
                    maxV = v;
                }
            }
            threshold = Math.floor((minV + maxV) / 2);
        }

        let count = 0;
        for (let y=0; y<3; y+=1) {
            let y_pos = startY + y * (size + gapY);
            for (let x=0; x<3; x+=1) {
                let x_pos = startX + x * (size + gapX);
                const outBuf = new ArrayBuffer(outSize ** 2);
                const view = new DataView(outBuf);
                for (let oy=0; oy<outSize; oy+=1) {
                    for (let ox=0; ox<outSize; ox+=1) {
                        let by = Math.round(y_pos + startOffset + oy * stepSize);
                        let bx = Math.round(x_pos + startOffset + ox * stepSize);
                        let v = buf[by * width + bx];
                        if (threshold > 0) {
                            v = (v >= threshold) ? 255 : 0;
                        }
                        view.setUint8(oy * outSize + ox, v);
                    }
                }
                if (save) {
                    saveFile(view, filenamePrefix + count + '.raw');
                }
                drawPreview(count, view);
                count += 1;
            }
        }
    }

    function loadFile(e) {
        let files = e.target.files;

        if (files.length == 0) {
            return;
        }

        let reader = new FileReader();
        reader.onload = function (e) {
            width = parseInt(widthInput.value);
            height = parseInt(heightInput.value);

            buf = new Uint8Array(e.target.result);
            draw();

        };
        reader.readAsArrayBuffer(files[0]);
        fileInput.value = null;
    }

    fileInput.onchange = loadFile;
    scaleInput.onchange = draw;
    startXInput.onchange = draw;
    startYInput.onchange = draw;
    sizeInput.onchange = draw;
    gapXInput.onchange = draw;
    gapYInput.onchange = draw;
    thresholdInput.onchange = draw;
    outSizeInput.onchange = draw;
    extractButton.onclick = extract;
  </script>
</body>
</html>
