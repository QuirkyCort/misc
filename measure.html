<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Position Measuring Tool</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      box-sizing: border-box;
      height: 100vh;
      margin: 0;
    }
    canvas {
      flex-grow: 1;
      border: solid 1px gray;
      height: 100%;
      width: 80vh;
      box-sizing: border-box;
    }
    input {
      width: 6em;
    }
    #touch {
      background: lightblue;
      width: 100%;
      height: 50vh;
      user-select: none;
    }
    .scale.selected {
      background: lightgreen;
    }
  </style>
</head>

<body>
  <canvas id="canvas"></canvas>
  <div id="controls">
    <button id="fullscreen">Fullscreen</button><br>
    <!-- <label>Pixel per mm: </label><input id="px_per_mm" type="number" value="20.591"><br> -->
    <label>Screen width mm: </label><input id="screen_width" type="number" value="135"><br>
    <label>Diameter: </label><input id="diameter" type="number" value="3" step="0.25">
    <div>X: <span id="x">0</span></div>
    <div>Y: <span id="y">0</span></div>
    <button class="scale selected" data="1">1x</button>
    <button class="scale" data="2">2x</button>
    <button class="scale" data="10">10x</button><br>
    <button id="zero">Set Zero</button>
    <div id="touch"></div>
  </div>
  <script>
    const canvas = document.getElementById('canvas');
    const touchDiv = document.getElementById('touch');
    const fullscreenBtn = document.getElementById('fullscreen');
    // const pxPerMmInput = document.getElementById('px_per_mm');
    const screenWidthInput = document.getElementById('screen_width');
    const diameterInput = document.getElementById('diameter');
    const xSpan = document.getElementById('x');
    const ySpan = document.getElementById('y');
    const widthSpan = document.getElementById('width');
    const zeroBtn = document.getElementById('zero');

    let cursorPosMM = [0, 0];
    let touchPos = [-1, -1];
    let pxPerMm = 0;
    let scale = 1;
    let zero = [0, 0];
    let diameter = 0;

    function adjustCanvasSize() {
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
    }

    function clearCanvas() {
      let ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function drawCursorMm() {
      let pX = cursorPosMM[0] * pxPerMm / window.devicePixelRatio;
      let pY = cursorPosMM[1] * pxPerMm / window.devicePixelRatio;
      let pRadius = diameter / 2 * pxPerMm / window.devicePixelRatio;

      pY = canvas.height - pY;

      clearCanvas();
      drawCursorPx(pX, pY, pRadius)
    }

    function drawCursorPx(x, y, radius) {
      let ctx = canvas.getContext("2d");
      ctx.lineWidth = 1;

      ctx.beginPath();
      ctx.moveTo(x, 0);
      ctx.lineTo(x, canvas.height);
      ctx.moveTo(0, y);
      ctx.lineTo(canvas.width, y);
      ctx.arc(x, y, radius, 0, 2 * Math.PI);
      ctx.stroke();
    }

    function saveTouch(e) {
      touchPos[0] = e.touches[0].clientX;
      touchPos[1] = e.touches[0].clientY;
    }

    function clearTouch(e) {
      touchPos = [-1, -1];
    }

    function touchMove(e) {
      if (touchPos[0] != -1) {
        let dx = e.touches[0].clientX - touchPos[0];
        let dy = e.touches[0].clientY - touchPos[1];

        dx *= window.devicePixelRatio;
        dy *= window.devicePixelRatio;

        dx /= pxPerMm;
        dy /= pxPerMm;

        dx /= scale;
        dy /= scale;

        cursorPosMM[0] += dx;
        cursorPosMM[1] -= dy;

        cursorPosMM[0] = Math.max(cursorPosMM[0], 0);
        cursorPosMM[1] = Math.max(cursorPosMM[1], 0);

        cursorPosMM[0] = Math.min(cursorPosMM[0], canvas.width / pxPerMm * window.devicePixelRatio);
        cursorPosMM[1] = Math.min(cursorPosMM[1], canvas.height / pxPerMm * window.devicePixelRatio);

        updateSpans();
        drawCursorMm()
      }
      saveTouch(e);
    }

    function updateSpans() {
      xSpan.innerText = Math.round((cursorPosMM[0] - zero[0]) * 100) / 100;
      ySpan.innerText = Math.round((cursorPosMM[1] - zero[1]) * 100) / 100;
    }

    function updatePxPerMm() {
      pxPerMm = Number(pxPerMmInput.value);
    }

    function updateDiameter() {
      diameter = Number(diameterInput.value);
      drawCursorMm();
    }

    function changeScale(e) {
      scale = Number(e.target.getAttribute('data'));
      for (let e of document.getElementsByClassName('scale')) {
        e.classList.remove('selected');
      }
      e.target.classList.add('selected');
    }

    function setZero() {
      zero[0] = cursorPosMM[0];
      zero[1] = cursorPosMM[1];
      updateSpans();
    }

    function fullscreen() {
      if (!document.fullscreenElement) {
        document.children[0].requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    }

    // function updateWidth() {
    //   widthSpan.innerText = document.children[0].offsetWidth * window.devicePixelRatio;
    // }

    function updateScreenWidth() {
      const pWidth = document.children[0].offsetWidth * window.devicePixelRatio;
      pxPerMm = pWidth / Number(screenWidthInput.value);
    }

    touchDiv.addEventListener('touchstart', saveTouch);
    touchDiv.addEventListener('touchend', clearTouch);
    touchDiv.addEventListener('touchmove', touchMove);
    for (let e of document.getElementsByClassName('scale')) {
      e.addEventListener('click', changeScale);
    }
    zeroBtn.addEventListener('click', setZero);
    // pxPerMmInput.addEventListener('change', updatePxPerMm);
    screenWidthInput.addEventListener('change', updateScreenWidth)
    diameterInput.addEventListener('change', updateDiameter);
    fullscreenBtn.addEventListener('click', fullscreen);


    adjustCanvasSize();
    // updatePxPerMm();
    updateScreenWidth()
    updateDiameter();
    // updateWidth();
  </script>
</body>
</html>
